<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Trading Performance Journal</title>

  <!-- Tailwind + ChartJS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    #trade-list-container { -webkit-overflow-scrolling: touch; }
    .spinner { border-top-color:#4f46e5 }
    .btn { @apply px-3 py-1 rounded-lg text-sm; }
  </style>
</head>

<body class="bg-gray-50 text-gray-800 min-h-screen p-4 md:p-8">

  <!-- Loading -->
  <div id="loading" class="fixed inset-0 hidden items-center justify-center bg-gray-50 z-50">
    <div class="text-center p-8 bg-white shadow-xl rounded-xl">
      <div class="spinner animate-spin rounded-full h-12 w-12 border-4 border-indigo-500 border-gray-200 mx-auto mb-4"></div>
      <p id="loading-msg" class="text-indigo-600 font-semibold">Loading…</p>
    </div>
  </div>

  <!-- Login -->
  <div id="login" class="max-w-sm mx-auto mt-16 bg-white shadow-xl rounded-xl p-6">
    <h1 class="text-2xl font-bold text-indigo-700 mb-2">Trading Journal Login</h1>
    <form id="login-form" class="space-y-3">
      <input id="email" type="email" placeholder="Email" class="w-full p-3 border rounded-lg" required />
      <input id="password" type="password" placeholder="Password" class="w-full p-3 border rounded-lg" required />
      <button class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg">Log in</button>
    </form>
    <p id="login-msg" class="text-sm text-red-600 mt-3"></p>
  </div>

  <!-- App -->
  <div id="app" class="max-w-7xl mx-auto hidden">
    <header class="mb-8 p-4 bg-white shadow-lg rounded-xl flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-indigo-700 mb-1">Trading Performance Journal</h1>
        <p class="text-sm text-gray-500">Add, edit, and close trades. Open trades do not affect totals.</p>
        <p id="auth-status" class="text-xs mt-2 text-indigo-400"></p>
      </div>
      <button id="logout" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg">Log out</button>
    </header>

    <!-- Metrics -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
      <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-indigo-500">
        <p class="text-xs text-gray-500 uppercase">Total Realized P&L</p>
        <p id="total-pnl" class="text-2xl font-bold mt-1">$0.00</p>
      </div>
      <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-green-500">
        <p class="text-xs text-gray-500 uppercase">Win Rate (closed)</p>
        <p id="win-rate" class="text-2xl font-bold mt-1">0%</p>
      </div>
      <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-yellow-500">
        <p class="text-xs text-gray-500 uppercase">Closed Trades</p>
        <p id="total-trades" class="text-2xl font-bold mt-1">0</p>
      </div>
      <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-red-500">
        <p class="text-xs text-gray-500 uppercase">Avg P&L (closed)</p>
        <p id="avg-pnl" class="text-2xl font-bold mt-1">$0.00</p>
      </div>
      <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-indigo-600">
        <p class="text-xs text-gray-500 uppercase">Last 14 Days (closed)</p>
        <p id="pnl-14d" class="text-2xl font-bold mt-1">$0.00</p>
      </div>
    </div>

    <!-- Charts -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
      <div class="bg-white p-6 rounded-xl shadow-lg lg:col-span-2">
        <h2 class="text-lg font-semibold text-indigo-600 mb-4">Cumulative Realized P&L</h2>
        <div class="relative h-64 md:h-96"><canvas id="pnlChart"></canvas></div>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h2 class="text-lg font-semibold text-indigo-600 mb-4">Closed Outcomes</h2>
        <div class="relative h-64"><canvas id="outcomesChart"></canvas></div>
      </div>
    </section>

    <!-- Add / Edit Entry -->
    <section class="bg-white p-6 rounded-xl shadow-lg mb-8">
      <h2 class="text-lg font-semibold text-indigo-600 mb-4" id="form-title">Log New Entry</h2>
      <form id="entry-form" class="grid grid-cols-2 md:grid-cols-8 gap-4">
        <input id="docId" type="hidden" />
        <select id="type" class="p-3 border rounded-lg">
          <option>Trade</option>
          <option>Deposit</option>
        </select>

        <input id="symbol" placeholder="Symbol" class="p-3 border rounded-lg col-span-2" />

        <input id="entryDate" type="date" class="p-3 border rounded-lg" />

        <input id="size" type="number" placeholder="Size" class="p-3 border rounded-lg" />

        <input id="entryPrice" type="number" step="0.01" placeholder="Entry / Amount" class="p-3 border rounded-lg" />

        <!-- Leave Exit blank to keep trade OPEN -->
        <input id="exitPrice" type="number" step="0.01" placeholder="Exit (leave blank if open)" class="p-3 border rounded-lg" />

        <select id="action" class="p-3 border rounded-lg">
          <option>Buy</option>
          <option>Call</option>
          <option>Put</option>
        </select>

        <button id="saveBtn" class="bg-indigo-600 text-white rounded-lg font-bold py-3 col-span-2 md:col-span-1">Add</button>
        <button id="cancelEditBtn" type="button" class="hidden bg-gray-200 rounded-lg font-semibold py-3 col-span-2 md:col-span-1">Cancel</button>
      </form>
      <div id="form-msg" class="text-red-600 text-xs mt-2"></div>
      <p class="text-xs text-gray-500 mt-2">Tip: Keep <b>Exit</b> empty for open trades. Open trades will not affect totals or charts.</p>
    </section>

    <!-- History -->
    <section class="bg-white p-6 rounded-xl shadow-lg">
      <h2 class="text-lg font-semibold text-indigo-600 mb-4">Transaction History</h2>
      <div id="trade-list-container" class="overflow-x-auto max-h-[500px]">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left">Date</th>
              <th class="px-3 py-2 text-left">Type</th>
              <th class="px-3 py-2 text-left">Asset</th>
              <th class="px-3 py-2 text-right">Entry</th>
              <th class="px-3 py-2 text-right">Exit</th>
              <th class="px-3 py-2 text-right">Size</th>
              <th class="px-3 py-2 text-left">Action</th>
              <th class="px-3 py-2 text-left">Status</th>
              <th class="px-3 py-2 text-right">Realized P&L</th>
              <th class="px-3 py-2 text-right">P&L %</th>
              <th class="px-3 py-2 text-right">Cum P&L</th>
              <th class="px-3 py-2 text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="trade-list"></tbody>
        </table>
      </div>
      <div id="empty" class="text-center py-6 text-gray-500 hidden">No entries yet</div>
    </section>
  </div>

  <!-- SCRIPT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    // --- Your Firebase config (exactly as you posted) ---
    const firebaseConfig = {
      apiKey: "AIzaSyB5rvkKPst6V9-7HoqK1f27jQj6x7f8LiA",
      authDomain: "trading-journal-da4eb.firebaseapp.com",
      projectId: "trading-journal-da4eb",
      storageBucket: "trading-journal-da4eb.firebasestorage.app",
      messagingSenderId: "50906470929",
      appId: "1:50906470929:web:b9ad784e9ae86c06d42fb0",
      measurementId: "G-WR261BKTXL"
    };

    // --- Init ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // --- Helpers ---
    const $ = id => document.getElementById(id);
    const show = el => el.classList.remove("hidden");
    const hide = el => el.classList.add("hidden");
    const money = n => new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(Number.isFinite(+n)?+n:0);
    const todayISO = () => {
      const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    };
    const setLoading = m => { $("loading-msg").textContent=m; $("loading").classList.remove("hidden"); };
    const clearLoading = () => $("loading").classList.add("hidden");

    // --- Auth UI ---
    setLoading("Checking session…");
    $("login-form").addEventListener("submit", async (e)=>{
      e.preventDefault();
      $("login-msg").textContent="";
      try{
        const email=$("email").value.trim();
        const pass =$("password").value.trim();
        await signInWithEmailAndPassword(auth,email,pass);
      }catch(err){ $("login-msg").textContent=err.message || String(err); }
    });
    $("logout").onclick = ()=>signOut(auth);

    onAuthStateChanged(auth, (user)=>{
      clearLoading();
      if(user){
        $("auth-status").textContent = "Signed in as: "+(user.email || user.uid);
        hide($("login")); show($("app"));
        boot(user.uid);
      }else{
        show($("login")); hide($("app"));
      }
    });

    // --- Firestore bindings ---
    let unsub=null, currentUid=null, editMode=false;

    function boot(uid){
      currentUid=uid;
      if(unsub) unsub();

      // query only my docs
      const ref = collection(db, "trades");
      const q   = query(ref, where("ownerUid","==",uid));

      // wire form
      $("entry-form").onsubmit = saveEntry;
      $("cancelEditBtn").onclick = resetForm;

      // live view
      unsub = onSnapshot(q, snap=>{
        const list=[]; snap.forEach(d=>list.push({id:d.id,...d.data()}));
        render(list.sort((a,b)=> new Date(a.entryDate) - new Date(b.entryDate)));
      });
    }

    function resetForm(){
      editMode=false;
      $("form-title").textContent = "Log New Entry";
      $("saveBtn").textContent = "Add";
      $("docId").value="";
      $("entry-form").reset();
      $("form-msg").textContent="";
      $("entryDate").value="";
    }

    async function saveEntry(e){
      e.preventDefault();
      $("form-msg").textContent="";

      const data = readForm();
      const ref  = collection(db, "trades");

      // validate
      if(data.type==="Trade"){
        if(!data.symbol) return $("form-msg").textContent="Symbol required";
        if(!(data.size>0)) return $("form-msg").textContent="Size must be > 0";
        if(!(data.entryPrice>0)) return $("form-msg").textContent="Entry must be > 0";
      }else if(data.type==="Deposit"){
        if(!(data.entryPrice>0)) return $("form-msg").textContent="Deposit 'Entry / Amount' must be > 0";
      }

      // compute realized only if CLOSED
      const hasExit = Number.isFinite(data.exitPrice) && data.exitPrice>0;
      if(data.type==="Trade" && hasExit){
        const dir = (data.action==="Put") ? -1 : 1; // Buy/Call = +1, Put = -1
        const pnl = (data.exitPrice - data.entryPrice) * data.size * dir;
        data.realizedPnl = +pnl.toFixed(2);
        data.pnlPct      = +(data.entryPrice>0 ? (pnl/(data.entryPrice*data.size))*100 : 0).toFixed(2);
        data.status      = "closed";
      }else if(data.type==="Trade"){
        data.exitPrice   = null;
        data.realizedPnl = null;
        data.pnlPct      = null;
        data.status      = "open";
      }else{
        // deposit row
        data.exitPrice   = null;
        data.realizedPnl = null;
        data.pnlPct      = null;
        data.status      = "n/a";
      }

      try{
        if(editMode && $("docId").value){
          await updateDoc(doc(db,"trades",$("docId").value), data);
        }else{
          await addDoc(ref, { ownerUid: currentUid, ...data, timestamp:new Date().toISOString() });
        }
        resetForm();
      }catch(err){
        $("form-msg").textContent = "Save failed: " + (err.message || err);
      }
    }

    function readForm(){
      const v = id => document.getElementById(id).value;
      const n = id => {
        const x = document.getElementById(id).value; return x===""? NaN : +x;
      };
      return {
        type: v("type"),
        symbol: (v("symbol")||"").toUpperCase(),
        entryDate: v("entryDate") || todayISO(),
        size: n("size"),
        entryPrice: n("entryPrice"),
        exitPrice: n("exitPrice"), // may be NaN -> handled in saveEntry
        action: v("action")
      };
    }

    // table render & actions
    window.editTrade = (id, row) => {
      editMode=true;
      $("form-title").textContent = "Edit Entry";
      $("saveBtn").textContent = "Save";
      show($("cancelEditBtn"));

      $("docId").value   = id;
      $("type").value    = row.type || "Trade";
      $("symbol").value  = row.symbol || "";
      $("entryDate").value = row.entryDate || "";
      $("size").value    = (row.size ?? "");
      $("entryPrice").value = (row.entryPrice ?? "");
      $("exitPrice").value  = (row.exitPrice ?? "");
      $("action").value  = row.action || "Buy";
      window.scrollTo({top:0,behavior:"smooth"});
    };

    window.closeTrade = async(id,row) => {
      try{
        if(row.type!=="Trade") return;
        if(row.status==="closed") return;

        // quick close helper: if exit empty, use entry (P&L = 0) so user can edit later
        await updateDoc(doc(db,"trades",id), {
          status:"closed",
          exitPrice: row.exitPrice && row.exitPrice>0 ? row.exitPrice : row.entryPrice,
          realizedPnl: 0,
          pnlPct: 0
        });
      }catch(e){ alert("Close failed: "+(e.message||e)); }
    };

    window.delTrade = async(id) => {
      try{ await deleteDoc(doc(db,"trades",id)); }
      catch(e){ alert(e.message||e); }
    };

    let pnlChart=null, outcomesChart=null;

    function render(list){
      const body=$("trade-list"); body.innerHTML="";
      const empty=$("empty");

      if(!list.length){
        show(empty);
        setTopline(0,0,0,0,0);
        updateCharts([]);
        return;
      }
      hide(empty);

      // compute totals using CLOSED trades only
      const closed = list.filter(x => x.type==="Trade" && x.status==="closed" && Number.isFinite(x.realizedPnl));
      const deposits = list.filter(x => x.type==="Deposit");

      let running=0, wins=0, losses=0, evens=0, last14=0;
      const cutISO=new Date(Date.now()-14*864e5).toISOString().split("T")[0];

      // table rows
      list.forEach(t=>{
        const isClosed = (t.status==="closed");
        const isOpen   = (t.type==="Trade" && t.status==="open");
        const pnl      = isClosed ? (t.realizedPnl||0) : null;
        if(isClosed) running += pnl;

        const cls = (pnl??0) >= 0 ? "text-green-600" : "text-red-600";
        const result = t.type!=="Trade" ? "-" : isOpen ? "Open" : (pnl>0?"Win":pnl<0?"Loss":"Breakeven");
        if(result==="Win")wins++; if(result==="Loss")losses++; if(result==="Breakeven")evens++;
        if(isClosed && t.entryDate>=cutISO) last14 += pnl;

        body.insertAdjacentHTML("beforeend",`
          <tr class="hover:bg-gray-50">
            <td class="px-3 py-2">${t.entryDate||"—"}</td>
            <td class="px-3 py-2">${t.type||"—"}</td>
            <td class="px-3 py-2 font-semibold text-indigo-600">${t.symbol||"—"}</td>
            <td class="px-3 py-2 text-right">${money(t.entryPrice)}</td>
            <td class="px-3 py-2 text-right">${t.exitPrice? money(t.exitPrice): "—"}</td>
            <td class="px-3 py-2 text-right">${Number.isFinite(t.size)? t.size: 0}</td>
            <td class="px-3 py-2">${t.action||"—"}</td>
            <td class="px-3 py-2">${t.status|| (t.exitPrice? "closed":"open")}</td>
            <td class="px-3 py-2 text-right ${isClosed?cls:''} font-semibold">${isClosed? money(pnl): "—"}</td>
            <td class="px-3 py-2 text-right ${isClosed?cls:''}">
              ${isClosed? ((Number.isFinite(t.pnlPct)? t.pnlPct:0).toFixed(2)+"%") : "—"}
            </td>
            <td class="px-3 py-2 text-right">${isClosed? money(running): "—"}</td>
            <td class="px-3 py-2 text-right space-x-2">
              <button class="btn bg-gray-100" onclick='editTrade("${t.id}", ${JSON.stringify(slim(t))})'>Edit</button>
              ${isOpen? `<button class="btn bg-amber-100" onclick='closeTrade("${t.id}", ${JSON.stringify(slim(t))})'>Mark Closed</button>`:""}
              <button class="btn bg-red-100 text-red-700" onclick='delTrade("${t.id}")'>Delete</button>
            </td>
          </tr>
        `);
      });

      const totalPnl = closed.reduce((a,b)=>a+(b.realizedPnl||0),0);
      const wr = closed.length ? (wins/closed.length)*100 : 0;
      const avg = closed.length ? totalPnl/closed.length : 0;

      setTopline(totalPnl, wr, closed.length, avg, last14);

      // charts use CLOSED trades only
      const sortedClosed = closed.sort((a,b)=> new Date(a.entryDate)-new Date(b.entryDate));
      updateCharts(sortedClosed);
    }

    function slim(t){
      // keep only fields we edit
      const o = {type:t.type, action:t.action, symbol:t.symbol, entryDate:t.entryDate,
                 size:t.size, entryPrice:t.entryPrice, exitPrice:t.exitPrice, status:t.status};
      return o;
    }

    function setTopline(totalPnl, wr, nTrades, avg, last14){
      $("total-pnl").textContent = money(totalPnl);
      $("total-pnl").className   = "text-2xl font-bold mt-1 " + (totalPnl>=0?"text-green-600":"text-red-600");
      $("win-rate").textContent  = (wr||0).toFixed(1) + "%";
      $("total-trades").textContent = String(nTrades||0);
      $("avg-pnl").textContent   = money(avg||0);
      $("pnl-14d").textContent   = money(last14||0);
      $("pnl-14d").className     = "text-2xl font-bold mt-1 " + (last14>=0?"text-green-600":"text-red-600");
    }

    function updateCharts(closed){
      const labels = closed.map(t=> `${t.entryDate} ${t.symbol||""}`.trim());
      let r=0; const cum = closed.map(t=> r += (t.realizedPnl||0));

      const w = closed.filter(t=>t.realizedPnl>0).length;
      const l = closed.filter(t=>t.realizedPnl<0).length;
      const z = closed.filter(t=>t.realizedPnl===0).length;

      if(!pnlChart){
        pnlChart = new Chart($("pnlChart"),{
          type:"line",
          data:{ labels, datasets:[{ label:"Cumulative Realized P&L", data:cum, borderColor:"#10b981" }]},
          options:{responsive:true,maintainAspectRatio:false}
        });
      }else{
        pnlChart.data.labels = labels;
        pnlChart.data.datasets[0].data = cum;
        pnlChart.update();
      }

      if(!outcomesChart){
        outcomesChart = new Chart($("outcomesChart"),{
          type:"doughnut",
          data:{ labels:["Win","Loss","Breakeven"], datasets:[{ data:[w,l,z], backgroundColor:["#10b981","#ef4444","#f59e0b"]}]},
          options:{responsive:true,maintainAspectRatio:false}
        });
      }else{
        outcomesChart.data.datasets[0].data = [w,l,z];
        outcomesChart.update();
      }
    }
  </script>
</body>
</html>
