<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,viewport-fit=cover"
  />
  <title>Trading Performance Journal</title>

  <!-- Tailwind & Chart.js -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <!-- PWA / Icons / Theming (cache-busted with ?v=7) -->
  <link rel="manifest" href="/manifest.json?v=7">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32.png?v=7">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16.png?v=7">
  <link rel="apple-touch-icon" href="/assets/icons/apple-touch-icon.png?v=7">
  <meta name="theme-color" content="#111827" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="application-name" content="Trading Journal" />
  <meta name="apple-mobile-web-app-title" content="Trading Journal" />

  <style>
    /* mobile-friendly scroll for the table */
    #trade-list-container { -webkit-overflow-scrolling: touch; }
    .spinner { border-top-color:#4f46e5 }

    /* subtle card accent on dark theme */
    .card-accent { border-left-width: 4px; }
  </style>
</head>

<body class="bg-gray-50 text-gray-800 min-h-screen p-4 md:p-8">

  <!-- Loading overlay -->
  <div id="loading" class="fixed inset-0 hidden items-center justify-center bg-gray-50 z-50">
    <div class="text-center p-8 bg-white shadow-xl rounded-xl">
      <div class="spinner animate-spin rounded-full h-12 w-12 border-4 border-indigo-500 border-gray-200 mx-auto mb-4"></div>
      <p id="loading-msg" class="text-indigo-600 font-semibold">Loading…</p>
    </div>
  </div>

  <!-- Login -->
  <div id="login" class="max-w-sm mx-auto mt-16 bg-white shadow-xl rounded-xl p-6">
    <h1 class="text-2xl font-bold text-indigo-700 mb-2">Trading Journal Login</h1>
    <p class="text-sm text-gray-500 mb-4">Secure access with email/password</p>
    <form id="login-form" class="space-y-3">
      <input id="email" type="email" placeholder="Email" class="w-full p-3 border rounded-lg" required />
      <input id="password" type="password" placeholder="Password" class="w-full p-3 border rounded-lg" required />
      <button class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg">Log in</button>
    </form>
    <p id="login-msg" class="text-sm text-red-600 mt-3"></p>
  </div>

  <!-- App -->
  <div id="app" class="max-w-7xl mx-auto hidden">
    <header class="mb-8 p-4 bg-white shadow-lg rounded-xl flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="/assets/icons/app-192.png?v=7" alt="icon" class="w-10 h-10 rounded-md" />
        <div>
          <h1 class="text-2xl md:text-3xl font-bold text-indigo-700">Trading Performance Journal</h1>
          <p class="text-sm text-gray-500">Log trades & deposits. Charts, P&L, win rate.</p>
          <p id="auth-status" class="text-xs mt-1 text-indigo-400"></p>
        </div>
      </div>
      <button id="logout" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg">Log out</button>
    </header>

    <!-- Metrics cards -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
      <div class="bg-white p-4 rounded-xl shadow-lg card-accent border-indigo-500">
        <p class="text-xs text-gray-500 uppercase">Total P&L</p>
        <p id="total-pnl" class="text-2xl font-bold mt-1">$0.00</p>
      </div>
      <div class="bg-white p-4 rounded-xl shadow-lg card-accent border-green-500">
        <p class="text-xs text-gray-500 uppercase">Win Rate</p>
        <p id="win-rate" class="text-2xl font-bold mt-1">0%</p>
      </div>
      <div class="bg-white p-4 rounded-xl shadow-lg card-accent border-yellow-500">
        <p class="text-xs text-gray-500 uppercase">Total Trades</p>
        <p id="total-trades" class="text-2xl font-bold mt-1">0</p>
      </div>
      <div class="bg-white p-4 rounded-xl shadow-lg card-accent border-red-500">
        <p class="text-xs text-gray-500 uppercase">Average P&L</p>
        <p id="avg-pnl" class="text-2xl font-bold mt-1">$0.00</p>
      </div>
      <div class="bg-white p-4 rounded-xl shadow-lg card-accent border-indigo-600">
        <p class="text-xs text-gray-500 uppercase">Last 14 Days</p>
        <p id="pnl-14d" class="text-2xl font-bold mt-1">$0.00</p>
      </div>
    </div>

    <!-- Charts -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
      <div class="bg-white p-6 rounded-xl shadow-lg lg:col-span-2">
        <h2 class="text-lg font-semibold text-indigo-600 mb-4">Cumulative P&L</h2>
        <div class="relative h-64 md:h-96"><canvas id="pnlChart"></canvas></div>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h2 class="text-lg font-semibold text-indigo-600 mb-4">Trade Outcomes</h2>
        <div class="relative h-64"><canvas id="outcomesChart"></canvas></div>
      </div>
    </section>

    <!-- Add Entry -->
    <section class="bg-white p-6 rounded-xl shadow-lg mb-8">
      <h2 class="text-lg font-semibold text-indigo-600 mb-4">Log New Entry</h2>
      <form id="add-form" class="grid grid-cols-2 md:grid-cols-8 gap-3 md:gap-4">
        <select id="type" class="p-3 border rounded-lg">
          <option>Trade</option><option>Deposit</option>
        </select>

        <!-- NEW: Asset Type -->
        <select id="assetType" class="p-3 border rounded-lg">
          <option>Stock</option><option>Crypto</option><option>Forex</option><option>Other</option>
        </select>

        <input id="symbol" placeholder="Symbol" class="p-3 border rounded-lg" />
        <input id="entryDate" type="date" class="p-3 border rounded-lg" />
        <input id="size" type="number" placeholder="Size" class="p-3 border rounded-lg" />
        <input id="entryPrice" type="number" step="0.01" placeholder="Entry / Amount" class="p-3 border rounded-lg" />
        <input id="exitPrice" type="number" step="0.01" placeholder="Exit (for trades)" class="p-3 border rounded-lg" />
        <select id="action" class="p-3 border rounded-lg">
          <option>Long</option><option>Short</option><option>Call</option><option>Put</option>
        </select>
        <button class="bg-indigo-600 text-white rounded-lg font-bold py-3 col-span-2 md:col-span-1">Add</button>
      </form>
      <div id="form-msg" class="text-red-600 text-xs mt-2"></div>
    </section>

    <!-- History -->
    <section class="bg-white p-6 rounded-xl shadow-lg">
      <h2 class="text-lg font-semibold text-indigo-600 mb-4">Transaction History</h2>
      <div id="trade-list-container" class="overflow-x-auto max-h-[440px]">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left">Date</th>
              <th class="px-3 py-2 text-left">Type</th>
              <th class="px-3 py-2 text-left">Asset Type</th>
              <th class="px-3 py-2 text-left">Asset</th>
              <th class="px-3 py-2 text-right">Entry</th>
              <th class="px-3 py-2 text-right">Exit</th>
              <th class="px-3 py-2 text-right">Size</th>
              <th class="px-3 py-2 text-left">Action</th>
              <th class="px-3 py-2 text-right">P&L</th>
              <th class="px-3 py-2 text-right">P&L %</th>
              <th class="px-3 py-2 text-right">Cum P&L</th>
              <th class="px-3 py-2 text-left">Result</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="trade-list"></tbody>
        </table>
      </div>
      <div id="empty" class="text-center py-6 text-gray-500 hidden">No entries yet</div>
    </section>
  </div>

  <!-- APP SCRIPT (single module) -->
  <script type="module">
    /***** Firebase imports *****/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    /***** CONFIG: update these if needed *****/
    const ALLOWED_EMAIL = "kaur.2804amandeep@gmail.com"; // <- your login email

    const firebaseConfig = {
      apiKey: "AIzaSyB5rvkKPst6V9-7HoqK1f27jQj6x7f8LiA",
      authDomain: "trading-journal-da4eb.firebaseapp.com",
      projectId: "trading-journal-da4eb",
      storageBucket: "trading-journal-da4eb.appspot.com",
      messagingSenderId: "50906470929",
      appId: "1:50906470929:web:b9ad784e9ae86c06d42fb0"
    };

    /***** Init *****/
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /***** DOM helpers *****/
    const $ = id => document.getElementById(id);
    const show = el => el.classList.remove("hidden");
    const hide = el => el.classList.add("hidden");
    const money = n => new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(Number(n)||0);
    const todayISO = () => {
      const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    };

    function setLoading(msg){ $("loading-msg").textContent=msg; show($("loading")); }
    function clearLoading(){ hide($("loading")); }

    /***** Login form *****/
    setLoading("Checking session…");
    $("login-form").addEventListener("submit", async (e)=>{
      e.preventDefault();
      $("login-msg").textContent="";
      try{
        const email=$("email").value.trim();
        const pass=$("password").value.trim();
        const cred=await signInWithEmailAndPassword(auth,email,pass);
        if(cred.user.email!==ALLOWED_EMAIL){
          $("login-msg").textContent="Not authorized for this app.";
          await signOut(auth);
          return;
        }
      }catch(err){ $("login-msg").textContent=err.message; }
    });
    $("logout").onclick=()=>signOut(auth);

    /***** Auth state *****/
    onAuthStateChanged(auth,(user)=>{
      clearLoading();
      if(user && user.email===ALLOWED_EMAIL){
        $("auth-status").textContent="Signed in as: "+user.email;
        hide($("login")); show($("app"));
        boot(user.uid);
      }else{
        show($("login")); hide($("app"));
      }
    });

    /***** App boot *****/
    let unsub=null;
    function boot(uid){
      if(unsub) unsub();

      const ref=collection(db,"trades");
      const q=query(ref,where("ownerUid","==",uid));

      // add entry
      $("add-form").onsubmit=async (e)=>{
        e.preventDefault();
        $("form-msg").textContent="";
        const type=$("type").value;
        const assetType=$("assetType").value;
        const symbol=($("symbol").value||"").toUpperCase();
        const entryDate=$("entryDate").value||todayISO();
        const size=+$("size").value||0;
        const entry=+$("entryPrice").value||0;
        const exit=+$("exitPrice").value||0;
        const action=$("action").value;

        if(type==="Trade" && (!symbol || size<=0)) return $("form-msg").textContent="Invalid trade: symbol & size required";
        if(type==="Deposit" && entry<=0) return $("form-msg").textContent="Invalid deposit: enter amount in Entry / Amount";

        let pnl=0, pct=0;
        if(type==="Trade"){
          const dir=(action==="Short"||action==="Put")?-1:1;
          pnl=(exit-entry)*size*dir;
          pct=entry>0?(pnl/(entry*size))*100:0;
        }

        try{
          await addDoc(ref,{
            ownerUid:uid,
            type, assetType, action, symbol,
            entryDate, size, entryPrice:entry, exitPrice:exit,
            pnl:+pnl.toFixed(2), pnlPct:+pct.toFixed(2),
            timestamp:new Date().toISOString()
          });
          e.target.reset();
        }catch(err){ $("form-msg").textContent="Error: "+err.message; }
      };

      // live view
      unsub=onSnapshot(q,(snap)=>{
        const list=[]; snap.forEach(d=>list.push({id:d.id,...d.data()}));
        render(list.sort((a,b)=>new Date(a.entryDate)-new Date(b.entryDate)));
      });
    }

    // delete trade
    window.delTrade=async(id)=>{ try{ await deleteDoc(doc(db,"trades",id)); }catch(e){ alert(e.message); } };

    // charts
    let pnlChart=null,outcomesChart=null;

    function render(list){
      const body=$("trade-list"); body.innerHTML="";
      const empty=$("empty");

      if(!list.length){
        show(empty);
        $("total-pnl").textContent="$0.00";
        $("win-rate").textContent="0%";
        $("total-trades").textContent="0";
        $("avg-pnl").textContent="$0.00";
        $("pnl-14d").textContent="$0.00";
        drawCharts([],[]); // clear charts
        return;
      }
      hide(empty);

      let running=0,w=0,l=0,z=0,last14=0;
      const cutISO=new Date(Date.now()-14*864e5).toISOString().split("T")[0];

      const labels=[], cum=[];
      list.forEach(t=>{
        // metrics
        running+=t.pnl||0;
        if(t.type==="Trade" && t.entryDate>=cutISO) last14+=t.pnl||0;

        const cls=(t.pnl||0)>=0?"text-green-600":"text-red-600";
        const result=t.type!=="Trade"?"-":t.pnl>0?"Win":t.pnl<0?"Loss":"Breakeven";
        if(result==="Win")w++; if(result==="Loss")l++; if(result==="Breakeven")z++;

        // table row
        body.insertAdjacentHTML("beforeend",`
          <tr class="hover:bg-gray-50">
            <td class="px-3 py-2">${t.entryDate||"-"}</td>
            <td class="px-3 py-2">${t.type||"-"}</td>
            <td class="px-3 py-2">${t.assetType||"-"}</td>
            <td class="px-3 py-2 font-semibold text-indigo-600">${t.symbol||"-"}</td>
            <td class="px-3 py-2 text-right">${money(t.entryPrice)}</td>
            <td class="px-3 py-2 text-right">${money(t.exitPrice)}</td>
            <td class="px-3 py-2 text-right">${Number.isFinite(t.size)?t.size:0}</td>
            <td class="px-3 py-2">${t.action||"-"}</td>
            <td class="px-3 py-2 text-right ${cls} font-semibold">${money(t.pnl)}</td>
            <td class="px-3 py-2 text-right ${cls}">${(Number.isFinite(t.pnlPct)?t.pnlPct:0).toFixed(2)}%</td>
            <td class="px-3 py-2 text-right">${money(running)}</td>
            <td class="px-3 py-2">${result}</td>
            <td class="px-3 py-2 text-right"><button class="text-red-600" onclick="delTrade('${t.id}')">X</button></td>
          </tr>
        `);

        // charts accumulators
        labels.push(`${t.entryDate} ${t.symbol||""}`.trim());
        cum.push(running);
      });

      const trades=list.filter(x=>x.type==="Trade");
      const total=list.reduce((a,b)=>a+(b.pnl||0),0);
      const wr=trades.length?(trades.filter(t=>t.pnl>0).length/trades.length)*100:0;

      $("pnl-14d").textContent=money(last14);
      $("win-rate").textContent=wr.toFixed(1)+"%";
      $("total-trades").textContent=String(trades.length);
      $("total-pnl").textContent=money(total);
      $("avg-pnl").textContent=money(total/(trades.length||1));

      drawCharts(labels,cum, trades);
    }

    function drawCharts(labels, cum, trades=[]) {
      const w = trades.filter(t=>t.pnl>0).length;
      const l = trades.filter(t=>t.pnl<0).length;
      const z = trades.filter(t=>t.pnl===0).length;

      if(!pnlChart){
        pnlChart=new Chart($("pnlChart"),{
          type:"line",
          data:{labels,datasets:[{label:"Cumulative P&L",data:cum,borderColor:"#10b981",tension:0.3}]},
          options:{responsive:true,maintainAspectRatio:false}
        });
      }else{
        pnlChart.data.labels=labels;
        pnlChart.data.datasets[0].data=cum;
        pnlChart.update();
      }

      if(!outcomesChart){
        outcomesChart=new Chart($("outcomesChart"),{
          type:"doughnut",
          data:{labels:["Win","Loss","Breakeven"],datasets:[{data:[w,l,z],backgroundColor:["#10b981","#ef4444","#f59e0b"]}]},
          options:{responsive:true,maintainAspectRatio:false,cutout:"70%"}
        });
      }else{
        outcomesChart.data.datasets[0].data=[w,l,z];
        outcomesChart.update();
      }
    }

    /***** Service Worker register (cache-busted) *****/
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('/service-worker.js?v=7').catch(console.error);
    }
  </script>
</body>
</html>
