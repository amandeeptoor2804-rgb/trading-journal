<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Trading Journal</title>
  
  <!-- Favicon + PWA -->
  <link rel="icon" type="image/svg+xml" href="icons/at-gold.svg">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111" />

  <!-- Styles -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    #trade-list-container { -webkit-overflow-scrolling: touch; }
    .spinner { border-top-color: #FACC15; }
  </style>
</head>

<body class="bg-black text-white min-h-screen">

<!-- Loading -->
<div id="loading" class="fixed inset-0 hidden items-center justify-center bg-black z-50">
  <div class="text-center p-8 bg-neutral-900 shadow-xl rounded-xl">
    <div class="spinner animate-spin rounded-full h-12 w-12 border-4 border-yellow-400 border-gray-700 mx-auto mb-4"></div>
    <p id="loading-msg" class="text-yellow-400 font-semibold">Loading...</p>
  </div>
</div>

<!-- LOGIN -->
<div id="login" class="max-w-sm mx-auto mt-20 bg-neutral-900 shadow-xl rounded-xl p-6">
  <h1 class="text-2xl font-bold text-yellow-400 mb-2">Trading Journal Login</h1>
  <form id="login-form" class="space-y-3">
    <input id="email" type="email" placeholder="Email" class="w-full p-3 border rounded-lg bg-black" required />
    <input id="password" type="password" placeholder="Password" class="w-full p-3 border rounded-lg bg-black" required />
    <button class="w-full bg-yellow-500 text-black font-semibold py-3 rounded-lg">Login</button>
  </form>
  <p id="login-msg" class="text-sm text-red-500 mt-3"></p>
</div>

<!-- APP -->
<div id="app" class="max-w-6xl mx-auto hidden p-4">

  <header class="mb-6 border-b border-neutral-700 pb-3 flex justify-between items-center">
    <h1 class="text-3xl font-bold text-yellow-400">Trading Journal</h1>
    <button id="logout" class="px-4 py-2 bg-neutral-800 hover:bg-neutral-700 rounded-lg">Logout</button>
  </header>

  <!-- Metrics -->
  <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
    <div class="bg-neutral-900 p-4 rounded-xl border-l-4 border-yellow-400">
      <p class="text-xs text-gray-400">Total P&L</p>
      <p id="total-pnl" class="text-xl font-bold mt-1">$0.00</p>
    </div>
    <div class="bg-neutral-900 p-4 rounded-xl border-l-4 border-green-500">
      <p class="text-xs text-gray-400">Win Rate</p>
      <p id="win-rate" class="text-xl font-bold mt-1">0%</p>
    </div>
    <div class="bg-neutral-900 p-4 rounded-xl border-l-4 border-blue-500">
      <p class="text-xs text-gray-400">Total Trades</p>
      <p id="total-trades" class="text-xl font-bold mt-1">0</p>
    </div>
    <div class="bg-neutral-900 p-4 rounded-xl border-l-4 border-red-500">
      <p class="text-xs text-gray-400">Avg P&L</p>
      <p id="avg-pnl" class="text-xl font-bold mt-1">$0.00</p>
    </div>
    <div class="bg-neutral-900 p-4 rounded-xl border-l-4 border-purple-500">
      <p class="text-xs text-gray-400">Last 14 Days</p>
      <p id="pnl-14d" class="text-xl font-bold mt-1">$0.00</p>
    </div>
  </div>

  <!-- Chart Row -->
  <section class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
    <div class="bg-neutral-900 p-6 rounded-xl lg:col-span-2">
      <h2 class="text-lg text-yellow-400 font-semibold mb-4">Cumulative P&L</h2>
      <canvas id="pnlChart"></canvas>
    </div>
    <div class="bg-neutral-900 p-6 rounded-xl">
      <h2 class="text-lg text-yellow-400 font-semibold mb-4">Trade Outcomes</h2>
      <canvas id="outcomesChart"></canvas>
    </div>
  </section>

  <!-- Add Entry -->
  <section class="bg-neutral-900 p-6 rounded-xl mb-8">
    <h2 class="text-lg text-yellow-400 font-semibold mb-4">New Entry</h2>
    <form id="add-form" class="grid grid-cols-2 md:grid-cols-7 gap-3">
      <select id="type" class="p-3 rounded bg-black"><option>Trade</option><option>Deposit</option></select>
      <input id="symbol" placeholder="Symbol" class="p-3 rounded bg-black col-span-2" />
      <input id="entryDate" type="date" class="p-3 rounded bg-black" />
      <input id="size" type="number" class="p-3 rounded bg-black" placeholder="Size" />
      <input id="entryPrice" type="number" step="0.01" placeholder="Entry" class="p-3 rounded bg-black" />
      <input id="exitPrice" type="number" step="0.01" placeholder="Exit" class="p-3 rounded bg-black" />
      <select id="action" class="p-3 rounded bg-black"><option>Long</option><option>Short</option><option>Call</option><option>Put</option></select>
      <button class="col-span-2 md:col-span-1 bg-yellow-500 text-black rounded font-bold py-3">Add</button>
    </form>
    <div id="form-msg" class="text-red-400 text-xs mt-2"></div>
  </section>

  <!-- Table -->
  <section class="bg-neutral-900 p-6 rounded-xl">
    <h2 class="text-lg text-yellow-400 font-semibold mb-4">Transaction History</h2>
    <div id="trade-list-container" class="overflow-x-auto max-h-[420px]">
      <table class="min-w-full text-sm divide-y divide-neutral-700">
        <thead><tr class="text-gray-500 text-xs">
          <th class="px-3 py-2 text-left">Date</th>
          <th class="px-3 py-2 text-left">Type</th>
          <th class="px-3 py-2 text-left">Asset</th>
          <th class="px-3 py-2 text-right">Entry</th>
          <th class="px-3 py-2 text-right">Exit</th>
          <th class="px-3 py-2 text-right">Size</th>
          <th class="px-3 py-2">Action</th>
          <th class="px-3 py-2 text-right">P&L</th>
          <th class="px-3 py-2 text-right">P&L %</th>
          <th class="px-3 py-2 text-right">Cum</th>
          <th class="px-3 py-2">Res</th>
          <th></th></tr></thead>
        <tbody id="trade-list"></tbody>
      </table>
    </div>
    <div id="empty" class="text-gray-500 text-center py-4 hidden">No entries yet</div>
  </section>

</div>

<!-- ✅ SECURE FIREBASE SCRIPT BUNDLE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB5rvkKPst6V9-7HoqK1f27jQj6x7f8LiA",
    authDomain: "trading-journal-da4eb.firebaseapp.com",
    projectId: "trading-journal-da4eb",
    storageBucket: "trading-journal-da4eb.appspot.com",
    messagingSenderId: "50906470929",
    appId: "1:50906470929:web:b9ad784e9ae86c06d42fb0"
  };

  const auth = getAuth(initializeApp(firebaseConfig));
  const db = getFirestore();

  const ALLOWED_EMAIL = "kaur.2804amandeep@gmail.com";
  const $ = id => document.getElementById(id);
  const money = n => `$${(Number(n)||0).toFixed(2)}`;

  function showLogin() { $("login").classList.remove("hidden"); $("app").classList.add("hidden"); }
  function showApp() { $("login").classList.add("hidden"); $("app").classList.remove("hidden"); }
  function showLoading(msg){ $("loading-msg").textContent=msg; $("loading").classList.remove("hidden"); }
  function hideLoading(){ $("loading").classList.add("hidden"); }

  $("login-form").addEventListener("submit", async(e)=>{
    e.preventDefault();
    try {
      const email=$("email").value.trim(), pass=$("password").value.trim();
      const userCred = await signInWithEmailAndPassword(auth,email,pass);
      if(userCred.user.email !== ALLOWED_EMAIL){
        $("login-msg").textContent="Not authorized"; await signOut(auth);
      }
    } catch(err){ $("login-msg").textContent=err.message; }
  });

  $("logout").onclick=()=>signOut(auth);

  onAuthStateChanged(auth, user=>{
    if(!user || user.email !== ALLOWED_EMAIL) return showLogin();
    $("auth-status").textContent=`${user.email}`;
    showApp(); startRealtime(user.uid);
  });

  function startRealtime(uid){
    const ref=collection(db,"trades");
    const q=query(ref, where("ownerUid","==",uid));

    $("add-form").addEventListener("submit",async e=>{
      e.preventDefault();
      const f=id=>$(id).value;
      const t=f("type"), s=(f("symbol")||"").toUpperCase();
      const d=f("entryDate"), sz=+f("size"), ep=+f("entryPrice"), xp=+f("exitPrice"), ac=f("action");
      if(t==="Trade" && (!s||sz<=0)) return;
      let pnl=0,pct=0; if(t==="Trade"){const dir=(ac==="Short"||ac==="Put")?-1:1;pnl=(xp-ep)*sz*dir;pct=(ep>0?(pnl/(ep*sz))*100:0)}
      await addDoc(ref,{ownerUid:uid,type:t,action:ac,symbol:s,entryDate:d,size:sz,entryPrice:ep,exitPrice:xp,pnl:+pnl.toFixed(2),pnlPct:+pct.toFixed(2),timestamp:new Date().toISOString()});
      e.target.reset();
    });

    onSnapshot(q,s=>{
      const L=[];s.forEach(d=>L.push({id:d.id,...d.data()}));
      renderTable(L.sort((a,b)=>new Date(a.entryDate)-new Date(b.entryDate)));
    });
  }

  window.delTrade=id=>deleteDoc(doc(db,"trades",id));

  function renderTable(list){
    const body=$("trade-list");body.innerHTML="";
    if(!list.length) return $("empty").classList.remove("hidden");
    $("empty").classList.add("hidden");
    let run=0,w=0,l=0,z=0,cut=new Date(Date.now()-14*864e5).toISOString().split("T")[0],last=0;
    list.forEach(t=>{
      run+=t.pnl; if(t.type==="Trade"&&t.entryDate>=cut) last+=t.pnl;
      const res=t.pnl>0?"Win":t.pnl<0?"Loss":"BE",cls=t.pnl>=0?"text-green-500":"text-red-500";
      if(res==="Win")w++;if(res==="Loss")l++;if(res==="BE")z++;
      body.insertAdjacentHTML("beforeend",`
        <tr><td>${t.entryDate}</td><td>${t.type}</td><td>${t.symbol}</td>
        <td class="text-right">${money(t.entryPrice)}</td>
        <td class="text-right">${money(t.exitPrice)}</td>
        <td class="text-right">${t.size}</td>
        <td>${t.action}</td>
        <td class="text-right ${cls}">${money(t.pnl)}</td>
        <td class="text-right ${cls}">${(t.pnlPct||0).toFixed(2)}%</td>
        <td class="text-right">${money(run)}</td>
        <td>${res}</td>
        <td><button class="text-red-500" onclick="delTrade('${t.id}')">✕</button></td></tr>`);
    });
    const T=list.filter(t=>t.type==="Trade"),sum=list.reduce((a,b)=>a+b.pnl,0);
    $("total-trades").textContent=T.length;
    $("total-pnl").textContent=money(sum);
    $("avg-pnl").textContent=money(sum/(T.length||1));
    $("win-rate").textContent=((w/T.length||0)*100).toFixed(1)+"%";
    $("pnl-14d").textContent=money(last);
  }
</script>

<!-- ✅ Register service worker -->
<script>
if ("serviceWorker" in navigator) navigator.serviceWorker.register("service-worker.js");
</script>
</body>
</html>
