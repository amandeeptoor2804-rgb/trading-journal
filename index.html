<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Trading Journal</title>

<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/svg+xml" href="icons/at-gold.svg" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  .spinner { border-top-color:#4f46e5; }
</style>
</head>

<body class="bg-gray-50 p-4">

<!-- LOGIN SCREEN -->
<div id="login-screen" class="max-w-sm mx-auto mt-16 bg-white p-6 shadow-xl rounded-xl">
  <h1 class="text-2xl font-bold text-indigo-700 mb-4">Trading Journal Login</h1>
  <form id="login-form" class="space-y-3">
    <input id="email" type="email" placeholder="Email" required class="w-full p-3 border rounded-lg"/>
    <input id="password" type="password" placeholder="Password" required class="w-full p-3 border rounded-lg"/>
    <button id="btn-login" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-bold">
      Log In
    </button>
  </form>
  <p id="login-msg" class="text-red-600 text-sm mt-2"></p>
</div>

<!-- APP -->
<div id="app-screen" class="hidden">
  <header class="flex justify-between items-center bg-white p-4 shadow-lg rounded-xl mb-6">
    <h1 class="text-2xl font-bold text-indigo-700">Trading Performance Journal</h1>
    <button id="btn-logout" class="bg-gray-200 px-4 py-2 rounded-lg">Log Out</button>
  </header>

  <div class="grid grid-cols-2 gap-4 mb-4">
    <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-green-600">
      <p>Total P&L</p><p id="total-pnl" class="font-bold">$0</p>
    </div>
    <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-indigo-600">
      <p>Win Rate</p><p id="win-rate" class="font-bold">0%</p>
    </div>
  </div>

  <section class="bg-white p-6 rounded-xl shadow-lg mb-6">
    <form id="add-form" class="grid grid-cols-2 gap-3">
      <select id="type" class="border p-2 rounded-lg">
        <option>Trade</option>
        <option>Deposit</option>
      </select>
      <input id="symbol" class="border p-2 rounded-lg" placeholder="Symbol"/>
      <input id="entryDate" type="date" class="border p-2 rounded-lg"/>
      <input id="size" type="number" class="border p-2 rounded-lg" placeholder="Size"/>
      <input id="entryPrice" type="number" step="0.01" class="border p-2 rounded-lg" placeholder="Entry/Amount"/>
      <input id="exitPrice" type="number" step="0.01" class="border p-2 rounded-lg" placeholder="Exit if Trade"/>
      <select id="action" class="border p-2 rounded-lg">
        <option>Long</option><option>Short</option><option>Call</option><option>Put</option>
      </select>
      <button class="bg-indigo-600 text-white p-2 rounded-lg col-span-2">Add</button>
    </form>
    <p id="form-msg" class="text-red-500 text-sm mt-2"></p>
  </section>

  <section class="bg-white p-4 rounded-xl shadow-lg">
    <h2 class="font-semibold text-indigo-600 mb-2">History</h2>
    <table class="w-full text-sm">
      <thead><tr><th>Date</th><th>Asset</th><th>P&L</th><th></th></tr></thead>
      <tbody id="trade-list"></tbody>
    </table>
  </section>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB5rvkKPst6V9-7HoqK1f27jQj6x7f8LiA",
  authDomain: "trading-journal-da4eb.firebaseapp.com",
  projectId: "trading-journal-da4eb",
  storageBucket: "trading-journal-da4eb.appspot.com",
  messagingSenderId: "50906470929",
  appId: "1:50906470929:web:b9ad784e9ae86c06d42fb0"
};

const ALLOWED_EMAIL = "kaur.2804amandeep@gmail.com";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const $ = id => document.getElementById(id);
const tradesRef = collection(db, "trades");

$("btn-login").onclick = e => e.target.blur();
$("btn-login").addEventListener("click", async (e)=>{
  e.preventDefault();
  const email = $("email").value;
  const pass = $("password").value;
  try {
    const cred = await signInWithEmailAndPassword(auth,email,pass);
    if(cred.user.email !== ALLOWED_EMAIL){
      $("login-msg").textContent = "Not authorized";
      signOut(auth);
    }
  } catch(err) { $("login-msg").textContent = err.message; }
});

$("btn-logout").addEventListener("click",()=>signOut(auth));

onAuthStateChanged(auth,(user)=>{
  if(user && user.email===ALLOWED_EMAIL){
    $("login-screen").classList.add("hidden");
    $("app-screen").classList.remove("hidden");
    loadTrades(user.uid);
  } else {
    $("login-screen").classList.remove("hidden");
    $("app-screen").classList.add("hidden");
  }
});

function loadTrades(uid){
  const q = query(tradesRef,where("ownerUid","==",uid));
  onSnapshot(q,(snap)=>{
    $("trade-list").innerHTML="";
    snap.forEach(d=>{
      const t = d.data();
      $("trade-list").insertAdjacentHTML("beforeend",`
      <tr>
        <td>${t.entryDate}</td><td>${t.symbol}</td>
        <td>${t.pnl}</td>
        <td><button onclick="del('${d.id}')">X</button></td>
      </tr>`);
    });
  });
}

window.del = id => deleteDoc(doc(db,"trades",id));
</script>

</body>
</html>
