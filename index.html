<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Trading Performance Journal</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<style>
  #trade-list-container { -webkit-overflow-scrolling: touch; }
  .spinner { border-top-color:#4f46e5 }
</style>
</head>

<body class="bg-gray-50 text-gray-800 min-h-screen p-4 md:p-8">

<!-- Loading -->
<div id="loading" class="fixed inset-0 flex items-center justify-center bg-gray-50 z-50 hidden">
  <div class="bg-white p-8 shadow-xl rounded-xl text-center">
    <div class="spinner animate-spin rounded-full h-10 w-10 border-4 border-indigo-500 border-gray-200 mx-auto mb-3"></div>
    <p id="loading-msg" class="text-indigo-600 font-semibold">Loading...</p>
  </div>
</div>

<!-- Login -->
<div id="login" class="max-w-sm mx-auto mt-20 bg-white shadow-xl rounded-xl p-6">
  <h1 class="text-2xl font-bold text-indigo-700 mb-1">Trading Journal Login</h1>
  <p class="text-sm text-gray-500 mb-4">Secure access</p>
  <form id="login-form" class="space-y-3">
    <input id="email" type="email" placeholder="Email" class="w-full p-3 border rounded-lg" required />
    <input id="password" type="password" placeholder="Password" class="w-full p-3 border rounded-lg" required />
    <button class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold">Log in</button>
  </form>
  <p id="login-msg" class="text-sm text-red-600 mt-2"></p>
</div>

<!-- APP -->
<div id="app" class="hidden max-w-7xl mx-auto">

  <header class="flex justify-between bg-white p-4 rounded-xl shadow-lg mb-6">
    <div>
      <h1 class="text-3xl font-bold text-indigo-700">Trading Performance Journal</h1>
      <p id="auth-status" class="text-xs text-indigo-400 mt-1"></p>
    </div>
    <button id="logout" class="bg-gray-100 px-4 py-2 rounded-lg hover:bg-gray-200">Log Out</button>
  </header>

  <!-- Metrics -->
  <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
    <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-indigo-500">
      <p class="text-xs text-gray-500">Total P&L</p>
      <p id="total-pnl" class="text-2xl font-bold mt-1">$0.00</p>
    </div>
    <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-green-500">
      <p class="text-xs text-gray-500">Win Rate</p>
      <p id="win-rate" class="text-2xl font-bold mt-1">0%</p>
    </div>
    <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-yellow-500">
      <p class="text-xs text-gray-500">Total Trades</p>
      <p id="total-trades" class="text-2xl font-bold mt-1">0</p>
    </div>
    <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-indigo-600">
      <p class="text-xs text-gray-500">Last 14 Days</p>
      <p id="pnl-14d" class="text-2xl font-bold mt-1">$0.00</p>
    </div>
    <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-red-500">
      <p class="text-xs text-gray-500">Avg P&L</p>
      <p id="avg-pnl" class="text-2xl font-bold mt-1">$0.00</p>
    </div>
  </div>

  <!-- Charts -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <div class="bg-white p-6 rounded-xl shadow-lg lg:col-span-2">
      <h2 class="text-indigo-600 font-semibold mb-3">Cumulative P&L</h2>
      <canvas id="pnlChart" class="h-64"></canvas>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-lg">
      <h2 class="text-indigo-600 font-semibold mb-3">Outcomes</h2>
      <canvas id="outcomesChart" class="h-64"></canvas>
    </div>
  </div>

  <!-- Add Entry -->
  <section class="bg-white p-6 rounded-xl shadow-lg mb-6">
    <h2 class="text-lg font-semibold text-indigo-600 mb-3">Log New Entry</h2>
    <form id="add-form" class="grid grid-cols-2 md:grid-cols-7 gap-3">
      <select id="type" class="p-3 border rounded-lg">
        <option>Trade</option><option>Deposit</option>
      </select>
      <input id="symbol" placeholder="Symbol" class="p-3 border rounded-lg col-span-2"/>
      <input id="entryDate" type="date" class="p-3 border rounded-lg"/>
      <input id="size" type="number" placeholder="Size" class="p-3 border rounded-lg"/>
      <input id="entryPrice" type="number" step="0.01" placeholder="Entry / Amount" class="p-3 border rounded-lg"/>
      <input id="exitPrice" type="number" step="0.01" placeholder="Exit (optional)" class="p-3 border rounded-lg"/>
      <button class="bg-indigo-600 text-white rounded-lg font-bold col-span-2 md:col-span-1 py-3">Add</button>
    </form>
    <p id="form-msg" class="text-xs text-red-600 mt-1"></p>
  </section>

  <!-- History -->
  <div class="bg-white p-6 rounded-xl shadow-lg">
    <h2 class="text-lg font-semibold text-indigo-600 mb-3">History</h2>
    <div id="trade-list-container" class="overflow-auto max-h-[420px]">
      <table class="w-full text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-3 py-2 text-left">Date</th>
            <th class="px-3 py-2 text-left">Type</th>
            <th class="px-3 py-2 text-left">Asset</th>
            <th class="px-3 py-2 text-right">Entry</th>
            <th class="px-3 py-2 text-right">Exit</th>
            <th class="px-3 py-2 text-right">Size</th>
            <th class="px-3 py-2 text-right">P&L</th>
            <th class="px-3 py-2 text-right">Cum</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="trade-list"></tbody>
      </table>
    </div>
    <p id="emptyMsg" class="text-gray-500 text-center mt-3 hidden">No entries</p>
  </div>

</div>

<!-- SCRIPT -->
<script type="module">

// âœ… IMPORTS
import {
 initializeApp
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";

import {
 getAuth,
 signInWithEmailAndPassword,
 signOut,
 onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

import {
 getFirestore,
 collection,
 addDoc,
 deleteDoc,
 doc,
 onSnapshot,
 query,
 where
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

// âœ… Only YOU can log in
const ADMIN_EMAIL = "kaur.2804amandeep@gmail.com";

// âœ… Firebase config
const firebaseConfig = {
 apiKey: "AIzaSyB5rvkKPst6V9-7HoqK1f27jQj6x7f8LiA",
 authDomain: "trading-journal-da4eb.firebaseapp.com",
 projectId: "trading-journal-da4eb",
 storageBucket: "trading-journal-da4eb.appspot.com",
 messagingSenderId: "50906470929",
 appId: "1:50906470929:web:b9ad784e9ae86c06d42fb0"
};

const appFB = initializeApp(firebaseConfig);
const auth = getAuth(appFB);
const db = getFirestore(appFB);

const $ = (id)=>document.getElementById(id);

// âœ… Show/Hide Helpers
function load(msg){ $("loading-msg").textContent=msg; $("loading").classList.remove("hidden"); }
function stopLoad(){ $("loading").classList.add("hidden"); }
function showApp(){ $("app").classList.remove("hidden"); $("login").classList.add("hidden"); }
function showLogin(){ $("login").classList.remove("hidden"); $("app").classList.add("hidden"); }

// âœ… Login
$("login-form").addEventListener("submit", async e=>{
 e.preventDefault();
 load("Signing in...");
 const email=$("email").value;
 const pass=$("password").value;
 try{
   const u=await signInWithEmailAndPassword(auth,email,pass);
   if(u.user.email !== ADMIN_EMAIL){
     $("login-msg").textContent="ðŸš« Not Authorized";
     await signOut(auth);
     stopLoad();
     return;
   }
 }catch(err){
   $("login-msg").textContent="Error: "+err.code;
   stopLoad();
 }
});

// âœ… Logout
$("logout").onclick=()=>signOut(auth);


// âœ… Auth Watcher
onAuthStateChanged(auth,(u)=>{
 stopLoad();
 if(u && u.email===ADMIN_EMAIL){
   $("auth-status").textContent="âœ… "+u.email;
   showApp();
   boot(u.uid);
 } else {
   showLogin();
 }
});

// âœ… DATABASE + UI UPDATES
let unsubscribe=null;
function boot(uid){
 if(unsubscribe) unsubscribe();
 const ref = collection(db,"trades");
 const q = query(ref, where("ownerUid","==",uid));

 $("add-form").onsubmit = async e =>{
   e.preventDefault();
   $("form-msg").textContent="";

   const type=$("type").value;
   const asset=($("symbol").value||"").toUpperCase();
   const date=$("entryDate").value;
   const size=+$("size").value;
   const entry=+$("entryPrice").value;
   const exit=+$("exitPrice").value;

   let pnl=0;
   if(type==="Trade") pnl=(exit-entry)*size;

   try{
     await addDoc(ref,{
       ownerUid:uid,
       type,asset,date,size,
       entry,exit,
       pnl:+pnl.toFixed(2),
       ts:new Date().toISOString()
     });
     e.target.reset();
   }catch(err){
     $("form-msg").textContent="âš ï¸ "+err.code;
   }
 };

 unsubscribe = onSnapshot(q, snap=>{
   const arr=[];
   snap.forEach(d=>arr.push({id:d.id,...d.data()}));
   render(arr.sort((a,b)=>new Date(a.date)-new Date(b.date)));
 });
}

window.delTrade = (id)=>deleteDoc(doc(db,"trades",id));

let pnlChart=null, outcomeChart=null;

// âœ… Draw UI
function render(list){
 const body=$("trade-list");
 body.innerHTML="";
 const empty=$("emptyMsg");

 if(!list.length){
   empty.classList.remove("hidden");
   updateMetrics(0,0,0,0,0);
   updateCharts([]);
   return;
 }
 empty.classList.add("hidden");

 let running=0,w=0,l=0,cutISO=new Date(Date.now()-14*864e5).toISOString().split("T")[0];
 let last14=0;

 list.forEach(t=>{
   running+=t.pnl;
   if(t.date>=cutISO) last14+=t.pnl;
   if(t.pnl>0) w++;
   if(t.pnl<0) l++;

   body.insertAdjacentHTML("beforeend",`
     <tr class="hover:bg-gray-50">
       <td class="px-3 py-1">${t.date}</td>
       <td class="px-3 py-1">${t.type}</td>
       <td class="px-3 py-1">${t.asset}</td>
       <td class="px-3 py-1 text-right">$${t.entry.toFixed(2)}</td>
       <td class="px-3 py-1 text-right">$${t.exit.toFixed(2)}</td>
       <td class="px-3 py-1 text-right">${t.size}</td>
       <td class="px-3 py-1 text-right font-bold ${t.pnl>=0?'text-green-600':'text-red-600'}">$${t.pnl}</td>
       <td class="px-3 py-1 text-right">$${running}</td>
       <td class="px-3 py-1 text-right"><button onclick="delTrade('${t.id}')" class="text-red-600 font-bold">âœ•</button></td>
     </tr>
   `);
 });

 updateMetrics(
   list.reduce((a,b)=>a+b.pnl,0),
   (w/(list.length||1))*100,
   list.length,
   list.reduce((a,b)=>a+b.pnl,0)/(list.length||1),
   last14
 );

 updateCharts(list);
}

function updateMetrics(total, wr, count, avg, last14){
 $("total-pnl").textContent="$"+total.toFixed(2);
 $("win-rate").textContent=wr.toFixed(1)+"%";
 $("total-trades").textContent=count;
 $("avg-pnl").textContent="$"+avg.toFixed(2);
 $("pnl-14d").textContent="$"+last14.toFixed(2);
}

function updateCharts(list){
 let r=0;
 const labels=list.map(t=>t.date+" "+t.asset);
 const cum=list.map(t=>r+=t.pnl);
 const wins=list.filter(t=>t.pnl>0).length;
 const losses=list.filter(t=>t.pnl<0).length;
 const zeros=list.filter(t=>t.pnl===0).length;

 if(!pnlChart){
   pnlChart=new Chart($("pnlChart"),{
     type:"line",
     data:{labels,datasets:[
       {label:"Cumulative P&L",data:cum,borderColor:"#4f46e5",fill:false}
     ]},
     options:{responsive:true,maintainAspectRatio:false}
   });
 } else {
   pnlChart.data.labels=labels;
   pnlChart.data.datasets[0].data=cum;
   pnlChart.update();
 }

 if(!outcomeChart){
   outcomeChart=new Chart($("outcomesChart"),{
     type:"doughnut",
     data:{labels:["Win","Loss","Zero"],datasets:[
       {data:[wins,losses,zeros],backgroundColor:["#10b981","#ef4444","#fbbf24"]}
     ]},
     options:{responsive:true,maintainAspectRatio:false}
   });
 } else {
   outcomeChart.data.datasets[0].data=[wins,losses,zeros];
   outcomeChart.update();
 }
}

</script>
</body>
</html>
